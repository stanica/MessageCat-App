{"version":3,"sources":["api/file/file.controller.js"],"names":["index","show","setBoot","list","getFile","getUpdate","create","upsert","patch","destroy","destroyLog","log","fs","require","path","readLastLines","luamin","respondWithResult","res","statusCode","entity","status","json","patchUpdates","patches","err","reject","save","removeEntity","remove","then","end","handleEntityNotFound","handleError","send","req","user","role","File","find","exec","catch","email","findById","params","id","folder","files","length","x","fileName","file","boot","saved","Esp","findOne","_id","espId","esp","update","sort","result","trim","writeHead","Buffer","byteLength","write","readFile","resolve","data","read","lines","query","min","minify","toString","writeFile","console","heartbeat","Date","now","body","text","unlink","chipId","JSON","parse","access","stream","createWriteStream","flags"],"mappings":"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","file":"file.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/files              ->  index\n * POST    /api/files              ->  create\n * GET     /api/files/:id          ->  show\n * PUT     /api/files/:id          ->  upsert\n * PATCH   /api/files/:id          ->  patch\n * DELETE  /api/files/:id          ->  destroy\n */\n\n'use strict';\n\nimport { applyPatch } from 'fast-json-patch';\nimport File from './file.model';\nimport Esp from '../esp/esp.model';\nconst fs = require('fs');\nconst path = require('path');\nconst readLastLines = require('read-last-lines');\nconst luamin = require('luamin');\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if(entity) {\n      return res.status(statusCode).json(entity);\n    }\n    return null;\n  };\n}\n\nfunction patchUpdates(patches) {\n  return function(entity) {\n    try {\n      applyPatch(entity, patches, /*validate*/ true);\n    } catch(err) {\n      return Promise.reject(err);\n    }\n\n    return entity.save();\n  };\n}\n\nfunction removeEntity(res) {\n  return function(entity) {\n    if(entity) {\n      return entity.remove()\n        .then(() => res.status(204).end());\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if(!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n// Gets a list of Files\nexport function index(req, res) {\n  if(req.user.role === 'admin'){\n    return File.find().exec()\n      .then(respondWithResult(res))\n      .catch(handleError(res));\n  }\n  else {\n    return File.find({email:req.user.email}).exec()\n    .then(handleEntityNotFound(res))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n  }\n}\n\n// Gets a single File from the DB\nexport function show(req, res) {\n  return File.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n//Sets boot flag for a file\nexport function setBoot(req, res) {\n  File.find({folder: req.params.id, email: req.user.email}, function(err, files){\n    if(err) { return handleError(res, 500)(err); }\n    if(files.length === 0) { return handleEntityNotFound(res)(); }\n    for(var x=0; x<files.length; x++){\n      if(files[x].fileName === req.params.file){\n        files[x].boot = 1;\n      }\n      else {\n        files[x].boot = 0;\n      }\n      files[x].save(function(err, saved){\n        if(err) { return handleError(res)(err); }\n      });\n    }\n    Esp.findOne({_id: files[files.length-1].espId}, function(err, esp){\n      if(err) { return handleError(res)(err); }\n      if(!esp) { return handleEntityNotFound(res)(); }\n      esp.update = 1;\n      esp.save(function(err, saved){\n        if(err) { return handleError(res)(err); }\n        return respondWithResult(res, 200)(files);\n      });\n    })\n  })\n}\n\n// Gets a list of files for a chip id\nexport function list(req, res) {\n  return Esp.findOne({'chipId':req.params.id}).exec()\n    .then(handleEntityNotFound(res))\n    .then(esp => {\n      return File.find({espId:esp._id}).sort({boot:-1}).exec(function(err, files){\n        if(!files) {\n         return res.status(404).end();\n        }\n        var result = '';\n        for(var x=0; x<files.length; x++){\n          if(x !== files.length-1){\n            result += files[x].fileName + '\\n';\n          }\n          else {\n            result += files[x].fileName;\n          }\n        }\n        result = result.trim();\n        res.writeHead(200, {'Content-Type':'text/json','Transfer-Encoding':'Identity', 'Content-Length': Buffer.byteLength(result)});\n        res.write(result);\n        res.end();\n        //respondWithResult(res, 200)(result);\n      });\n    })\n    .catch(handleError(res));\n}\n\n// Gets file content for a single file\nexport function getFile(req, res) {\n  fs.readFile(path.resolve('server/uploads/') + '/' + req.params.id + '/' + req.params.file, \"utf8\", function(err, data){\n    if(!err){\n      if(req.params.file === 'log.txt'){\n        readLastLines.read(path.resolve('server/uploads/') + '/' + req.params.id + '/' + req.params.file, 50)\n          .then((lines) => {\n            res.writeHead(200, {'Content-Type':'text/json','Transfer-Encoding':'Identity', 'Content-Length': Buffer.byteLength(lines)});\n            res.write(lines);\n            res.end();\n          });\n      }\n      else {\n        if(req.query.min === 'true'){\n          data = luamin.minify(data);\n        }\n        res.writeHead(200, {'Content-Type':'text/json','Transfer-Encoding':'Identity', 'Content-Length': Buffer.byteLength(data.toString())});\n        res.write(data);\n        res.end();\n      }\n    }\n    else {\n      if(req.params.file === 'log.txt'){\n        fs.writeFile(path.resolve('server/uploads/') + '/' + req.params.id + '/log.txt',\"\", function(err){\n          if(err){\n            console.log('Error writing log.txt', err);\n            return handleError(res)(err);\n          }\n        });\n        res.writeHead(200, {'Content-Type':'text/json','Transfer-Encoding':'Identity', 'Content-Length': 0});\n        res.write(\"\");\n        res.end();\n      }\n      else {\n        return handleError(res)(err);\n      }\n    }\n  });\n}\n\n// Gets update status for ESP board\nexport function getUpdate(req, res) {\n  return Esp.findOne({'chipId':req.params.id}).exec()\n    .then(handleEntityNotFound(res))\n    .then((esp, err) => {\n      if(err){\n        return handleError(res)(err);\n      }\n      res.writeHead(200, {'Content-Type':'text/json','Transfer-Encoding':'Identity'});\n      if(esp.update === 1){\n        res.write('UPDATE');\n        esp.update = 0;\n      }\n      else {\n        res.write('');\n      }\n      res.end();\n      esp.heartbeat = Date.now();\n      esp.save();\n    });\n}\n\n// Creates a new File in the DB\nexport function create(req, res) {\n  if(req.body.fileName) {\n    return File.create(req.body)\n      .then(file => {\n        fs.writeFile(path.resolve('server/uploads/') + '/' + req.body.folder + '/' + req.body.fileName, \"\", function(err){\n          if(err){\n            console.log(err);\n          }\n          return respondWithResult(res, 201)(file);\n        });\n      })\n      .catch(handleError(res));\n  }\n  else {\n    return handleEntityNotFound(res)({});\n  }\n}\n\n// Upserts the given File in the DB at the specified ID\nexport function upsert(req, res) {\n  if(req.body._id) {\n    Reflect.deleteProperty(req.body, '_id');\n  }\n  fs.writeFile(path.resolve('server/uploads/') + '/' + req.body.folder + '/' + req.body.fileName, req.body.text, function(err){\n    if(err){\n      console.log(err);\n    }\n    else {\n      Esp.findOne({_id:req.body.espId}, function(err, esp){\n        if(err) { return handleError(res)(err); }\n        if(!esp) { return handleEntityNotFound(res)(); }\n        esp.update = 1;\n        esp.save(function(err, saved){\n          if(err) { return handleError(res)(err); }\n          respondWithResult(res, 201)({status:'success'});\n        });\n      });\n    }\n  })\n}\n\n// Updates an existing File in the DB\nexport function patch(req, res) {\n  if(req.body._id) {\n    Reflect.deleteProperty(req.body, '_id');\n  }\n  return File.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(patchUpdates(req.body))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Deletes a File from the DB\nexport function destroy(req, res) {\n  if(req.params.id){\n    return File.findById(req.params.id).exec()\n      .then(handleEntityNotFound(res))\n      .then(file => {\n        fs.unlink(path.resolve('server/uploads') + '/' + file.folder + '/' + file.fileName, function(err){\n          return removeEntity(res)(file);\n        })\n      })\n      .catch(handleError(res));\n  }\n  else {\n    \n  }\n}\n\n// Deletes log files\nexport function destroyLog(req, res) {\n  if(req.params.id){\n    return Esp.findOne({'chipId':req.params.id, 'email': req.user.email}).exec()\n      .then(handleEntityNotFound(res))\n      .then(esp => {\n        fs.unlink(path.resolve('server/uploads') + '/' + esp.chipId + '/log.txt', function(err){\n          respondWithResult(res, 201)({status:'success'});\n        })\n      })\n      .catch(handleError(res));\n  }\n}\n\n// Writes to a log file\nexport function log(req, res) {\n  req.body = JSON.parse(req.body);\n  fs.access(path.resolve('server/uploads/') + '/' + req.params.id + '/log.txt', \"utf8\", function(err){\n    if(err){\n      fs.writeFile(path.resolve('server/uploads/') + '/' + req.params.id + '/log.txt', req.body.text + '\\n', function(err){\n        if(err){\n          console.log('Error writing to log.txt',err);\n        }\n      });\n    }\n    else {\n      var stream = fs.createWriteStream(path.resolve('server/uploads/') + '/' + req.params.id + '/log.txt', {flags:'a'});\n      stream.write(req.body.text + '\\n');\n      stream.end();\n    }\n  })\n  respondWithResult(res, 201)({status:'success'});\n}\n"]}